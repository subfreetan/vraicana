<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4213D">
    <title>Canadian Burger City</title>
    <link rel="icon" type="image/png" href="images/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#D4213D;--primary-dark:#B01B32;--secondary:#F5A623;--dark:#1A1A1A;--dark-light:#2D2D2D;--gray:#6B6B6B;--gray-light:#E5E5E5;--white:#FFF;--success:#4CAF50;--warning:#FF9800;--error:#F44336;--gradient-red:linear-gradient(135deg,#D4213D 0%,#8B1425 100%);--gradient-gold:linear-gradient(135deg,#F5A623 0%,#D4900F 100%);--radius:16px;--radius-sm:10px;--safe-bottom:env(safe-area-inset-bottom)}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Poppins',sans-serif;background:var(--dark);color:var(--white);min-height:100vh;overflow-x:hidden;padding-bottom:calc(80px + var(--safe-bottom))}
        ::-webkit-scrollbar{display:none}
        .header{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--dark);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.1)}
        .header-logo{height:45px;object-fit:contain;cursor:pointer}
        .points-badge{background:var(--gradient-gold);padding:8px 14px;border-radius:20px;font-weight:600;font-size:14px;color:var(--dark);display:flex;align-items:center;gap:6px;cursor:pointer}
        .points-badge.guest{background:var(--dark-light);color:var(--white);font-size:13px}
        .main-content{padding-top:70px}
        .hero{padding:20px 16px;background:var(--gradient-red);margin:10px 16px 0;border-radius:var(--radius);position:relative;overflow:hidden}
        .hero::before{content:'';position:absolute;top:-50%;right:-30%;width:200px;height:200px;background:rgba(255,255,255,0.1);border-radius:50%}
        .hero h1{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;margin-bottom:8px}
        .hero p{font-size:14px;opacity:0.9;margin-bottom:16px}
        .hero-btn{display:inline-flex;align-items:center;gap:8px;background:var(--white);color:var(--primary);padding:12px 24px;border-radius:30px;font-weight:600;font-size:14px;text-decoration:none}
        .section-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:1px;padding:20px 16px 12px;display:flex;justify-content:space-between;align-items:center}
        .section-title a{font-family:'Poppins',sans-serif;font-size:13px;color:var(--secondary);text-decoration:none;font-weight:500}
        .categories{display:flex;gap:12px;padding:0 16px;overflow-x:auto;scroll-snap-type:x mandatory}
        .category-card{flex-shrink:0;scroll-snap-align:start;width:85px;height:85px;background:var(--dark-light);border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
        .category-card.active{background:var(--gradient-red);border-color:var(--secondary)}
        .category-card span:first-child{font-size:26px}
        .category-card span:last-child{font-size:11px;font-weight:500}
        .products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 16px 20px}
        .product-card{background:var(--dark-light);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:transform 0.2s}
        .product-card:active{transform:scale(0.98)}
        .product-image{width:100%;height:110px;background:var(--gradient-red);display:flex;align-items:center;justify-content:center;font-size:44px}
        .product-info{padding:12px}
        .product-name{font-weight:600;font-size:13px;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .product-price{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--secondary)}
        .product-unavailable{opacity:0.5;pointer-events:none}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--dark);border-top:1px solid rgba(255,255,255,0.1);padding:8px 0 calc(8px + var(--safe-bottom));display:flex;justify-content:space-around;z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 12px;color:var(--gray);text-decoration:none;font-size:10px;font-weight:500;cursor:pointer;background:none;border:none}
        .nav-item.active{color:var(--primary)}
        .nav-item svg{width:22px;height:22px}
        .nav-item-cart{position:relative}
        .cart-badge{position:absolute;top:0;right:4px;background:var(--primary);color:var(--white);font-size:10px;font-weight:700;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal-overlay.active{opacity:1;visibility:visible}
        .bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:var(--dark);border-radius:24px 24px 0 0;z-index:201;transform:translateY(100%);transition:transform 0.3s ease-out;max-height:90vh;overflow-y:auto}
        .bottom-sheet.active{transform:translateY(0)}
        .sheet-handle{width:40px;height:4px;background:var(--gray);border-radius:2px;margin:12px auto}
        .sheet-header{padding:0 20px 16px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center}
        .sheet-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:1px}
        .sheet-close{width:36px;height:36px;border-radius:50%;background:var(--dark-light);border:none;color:var(--white);font-size:20px;cursor:pointer}
        .sheet-content{padding:20px;padding-bottom:calc(20px + var(--safe-bottom))}
        .product-detail-image{width:100%;height:180px;background:var(--gradient-red);display:flex;align-items:center;justify-content:center;font-size:70px;margin-bottom:20px;border-radius:var(--radius)}
        .product-detail-name{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1px;margin-bottom:8px}
        .product-detail-desc{color:var(--gray-light);font-size:14px;line-height:1.5;margin-bottom:20px}
        .quantity-selector{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px}
        .qty-btn{width:48px;height:48px;border-radius:50%;background:var(--dark-light);border:2px solid var(--primary);color:var(--white);font-size:24px;cursor:pointer}
        .qty-btn:active{background:var(--primary)}
        .qty-value{font-family:'Bebas Neue',sans-serif;font-size:32px;min-width:50px;text-align:center}
        .add-to-cart-btn,.checkout-btn,.auth-btn{width:100%;padding:16px;background:var(--gradient-red);border:none;border-radius:30px;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .add-to-cart-btn:active,.checkout-btn:active,.auth-btn:active{transform:scale(0.98)}
        .checkout-btn:disabled{opacity:0.5;cursor:not-allowed}
        .cart-empty{text-align:center;padding:60px 20px}
        .cart-empty-icon{font-size:64px;margin-bottom:16px}
        .cart-empty h2{font-family:'Bebas Neue',sans-serif;font-size:24px;margin-bottom:8px}
        .cart-empty p{color:var(--gray);font-size:14px}
        .cart-item{display:flex;gap:12px;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
        .cart-item-image{width:70px;height:70px;background:var(--gradient-red);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:14px;margin-bottom:4px}
        .cart-item-price{color:var(--secondary);font-weight:600;font-size:13px}
        .cart-item-qty{display:flex;align-items:center;gap:10px;margin-top:8px}
        .cart-qty-btn{width:28px;height:28px;border-radius:50%;background:var(--dark-light);border:1px solid var(--gray);color:var(--white);font-size:16px;cursor:pointer}
        .cart-item-actions{display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end}
        .cart-remove-btn{background:none;border:none;color:var(--error);font-size:18px;cursor:pointer}
        .cart-summary{background:var(--dark-light);padding:16px;border-radius:var(--radius);margin-top:20px}
        .cart-summary-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}
        .cart-summary-row.total{font-size:18px;font-weight:700;border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;margin-bottom:0}
        .cart-summary-row .points{color:var(--secondary)}
        .auth-page{padding:20px}
        .auth-logo{display:block;width:100px;margin:20px auto 30px}
        .auth-title{font-family:'Bebas Neue',sans-serif;font-size:32px;text-align:center;margin-bottom:8px}
        .auth-subtitle{text-align:center;color:var(--gray);font-size:14px;margin-bottom:30px}
        .form-group{margin-bottom:20px}
        .form-label{display:block;font-size:14px;font-weight:500;margin-bottom:8px;color:var(--gray-light)}
        .form-input{width:100%;padding:14px;background:var(--dark-light);border:2px solid transparent;border-radius:var(--radius-sm);color:var(--white);font-size:16px;font-family:inherit}
        .form-input:focus{outline:none;border-color:var(--primary)}
        .form-input::placeholder{color:var(--gray)}
        .auth-link{text-align:center;margin-top:20px;font-size:14px;color:var(--gray)}
        .auth-link a{color:var(--secondary);text-decoration:none;font-weight:600}
        .rewards-header{background:var(--gradient-gold);margin:0 16px;padding:24px;border-radius:var(--radius);text-align:center;color:var(--dark)}
        .rewards-points{font-family:'Bebas Neue',sans-serif;font-size:48px}
        .rewards-points-label{font-weight:600}
        .rewards-info{margin-top:8px;font-size:13px;opacity:0.8}
        .reward-card{background:var(--dark-light);border-radius:var(--radius);padding:14px;display:flex;gap:14px;align-items:center;margin-bottom:10px}
        .reward-icon{width:55px;height:55px;background:var(--gradient-red);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
        .reward-info{flex:1}
        .reward-name{font-weight:600;font-size:14px;margin-bottom:2px}
        .reward-desc{font-size:11px;color:var(--gray)}
        .reward-claim-btn{background:var(--gradient-red);border:none;padding:10px 16px;border-radius:20px;color:var(--white);font-weight:600;font-size:12px;cursor:pointer}
        .reward-claim-btn:disabled{opacity:0.5;cursor:not-allowed}
        .my-reward-card{background:var(--dark-light);border-radius:var(--radius);padding:14px;margin-bottom:10px}
        .my-reward-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .my-reward-status{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .my-reward-status.available{background:var(--success)}
        .my-reward-status.used{background:var(--gray)}
        .my-reward-code{background:var(--dark);padding:10px;border-radius:var(--radius-sm);text-align:center;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--secondary)}
        .order-card{background:var(--dark-light);border-radius:var(--radius);padding:14px;margin-bottom:10px}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-code{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px}
        .order-status{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .order-status.pending{background:var(--warning);color:var(--dark)}
        .order-status.preparing{background:var(--primary)}
        .order-status.ready{background:var(--success)}
        .order-status.completed{background:var(--gray)}
        .order-items{font-size:13px;color:var(--gray-light);margin-bottom:8px}
        .order-footer{display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,0.1);padding-top:10px}
        .order-total{font-weight:700;color:var(--secondary)}
        .order-date{font-size:11px;color:var(--gray)}
        .order-qr-btn{background:var(--gradient-red);border:none;padding:8px 14px;border-radius:20px;color:var(--white);font-weight:600;font-size:12px;cursor:pointer}
        .qr-container{background:var(--white);padding:20px;border-radius:var(--radius);text-align:center;margin:20px 0}
        .qr-code-text{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--dark);margin-top:12px}
        .qr-instructions{text-align:center;color:var(--gray);font-size:14px;margin-top:12px}
        .profile-header{text-align:center;padding:20px}
        .profile-avatar{width:90px;height:90px;background:var(--gradient-red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 14px}
        .profile-name{font-family:'Bebas Neue',sans-serif;font-size:26px}
        .profile-email{color:var(--gray);font-size:13px}
        .profile-menu{padding:0 16px}
        .profile-menu-item{display:flex;align-items:center;gap:14px;padding:14px;background:var(--dark-light);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer}
        .profile-menu-item:active{background:var(--dark)}
        .profile-menu-icon{width:42px;height:42px;background:var(--gradient-red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
        .profile-menu-text{flex:1}
        .profile-menu-text h3{font-size:14px;font-weight:600;margin-bottom:2px}
        .profile-menu-text p{font-size:11px;color:var(--gray)}
        .profile-menu-arrow{color:var(--gray);font-size:18px}
        .logout-btn{width:calc(100% - 32px);margin:20px 16px;padding:14px;background:transparent;border:2px solid var(--error);border-radius:30px;color:var(--error);font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;cursor:pointer}
        .order-type-selector{display:flex;gap:12px;margin-bottom:20px}
        .order-type-btn{flex:1;padding:14px;background:var(--dark-light);border:2px solid transparent;border-radius:var(--radius);color:var(--white);font-weight:600;font-size:13px;cursor:pointer;text-align:center}
        .order-type-btn.selected{border-color:var(--primary);background:rgba(212,33,61,0.2)}
        .order-type-icon{font-size:26px;margin-bottom:6px}
        .pickup-time-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
        .pickup-time-btn{padding:10px;background:var(--dark-light);border:2px solid transparent;border-radius:var(--radius-sm);color:var(--white);font-size:13px;font-weight:500;cursor:pointer}
        .pickup-time-btn.selected{border-color:var(--primary);background:rgba(212,33,61,0.2)}
        .cart-rewards{background:var(--dark-light);padding:14px;border-radius:var(--radius);margin-bottom:20px}
        .cart-rewards h3{font-size:14px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .cart-reward-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
        .cart-reward-item:last-child{border-bottom:none}
        .cart-reward-checkbox{width:22px;height:22px;accent-color:var(--primary)}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark-light);padding:12px 20px;border-radius:30px;font-size:14px;font-weight:500;z-index:300;opacity:0;transition:all 0.3s}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--error)}
        .page{display:none;padding-bottom:20px}
        .page.active{display:block}
    </style>
</head>
<body>
    <header class="header">
        <img src="images/logo.png" alt="Canadian Burger" class="header-logo" onclick="showPage('home')">
        <div id="userPointsBadge" class="points-badge guest" onclick="showPage('rewards')">Se connecter</div>
    </header>

    <main class="main-content">
        <div id="homePage" class="page active">
            <div class="hero">
                <h1>BIENVENUE CHEZ CANADIAN BURGER</h1>
                <p>Les meilleurs burgers de Spa üçÅ</p>
                <a href="#" class="hero-btn" onclick="showPage('menu')">Commander ‚Üí</a>
            </div>
            <h2 class="section-title">Cat√©gories</h2>
            <div id="categoriesContainer" class="categories"></div>
            <h2 class="section-title"><span>Populaires</span><a href="#" onclick="showPage('menu')">Voir tout</a></h2>
            <div id="popularProducts" class="products-grid"></div>
        </div>

        <div id="menuPage" class="page">
            <h2 class="section-title">Notre Carte</h2>
            <div id="menuCategories" class="categories" style="margin-bottom:16px"></div>
            <div id="menuProducts" class="products-grid"></div>
        </div>

        <div id="cartPage" class="page">
            <h2 class="section-title">Mon Panier</h2>
            <div id="cartContent" class="sheet-content"></div>
        </div>

        <div id="rewardsPage" class="page">
            <div id="rewardsContent"></div>
        </div>

        <div id="profilePage" class="page">
            <div id="profileContent"></div>
        </div>

        <div id="ordersPage" class="page">
            <h2 class="section-title">Mes Commandes</h2>
            <div id="ordersContent" class="sheet-content"></div>
        </div>

        <div id="loginPage" class="page">
            <div class="auth-page">
                <img src="images/logo.png" alt="Canadian Burger" class="auth-logo">
                <h1 class="auth-title">CONNEXION</h1>
                <p class="auth-subtitle">Connectez-vous pour gagner des points</p>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="auth-btn">SE CONNECTER</button>
                </form>
                <p class="auth-link">Pas encore de compte ? <a href="#" onclick="showPage('register')">S'inscrire</a></p>
                <p class="auth-link"><a href="#" onclick="showPage('home')">‚Üê Retour</a></p>
            </div>
        </div>

        <div id="registerPage" class="page">
            <div class="auth-page">
                <img src="images/logo.png" alt="Canadian Burger" class="auth-logo">
                <h1 class="auth-title">INSCRIPTION</h1>
                <p class="auth-subtitle">Cr√©ez votre compte et gagnez des points</p>
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Nom complet</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Jean Dupont" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√©l√©phone</label>
                        <input type="tel" class="form-input" id="registerPhone" placeholder="0471234567" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                    </div>
                    <button type="submit" class="auth-btn">CR√âER MON COMPTE</button>
                </form>
                <p class="auth-link">D√©j√† un compte ? <a href="#" onclick="showPage('login')">Se connecter</a></p>
            </div>
        </div>

        <div id="checkoutPage" class="page">
            <h2 class="section-title">Finaliser</h2>
            <div id="checkoutContent" class="sheet-content"></div>
        </div>

        <div id="confirmationPage" class="page">
            <div id="confirmationContent" class="sheet-content" style="text-align:center;padding-top:40px"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" data-page="home" onclick="showPage('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Accueil</span>
        </button>
        <button class="nav-item" data-page="menu" onclick="showPage('menu')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            <span>Menu</span>
        </button>
        <button class="nav-item nav-item-cart" data-page="cart" onclick="showPage('cart')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            <span id="cartBadge" class="cart-badge" style="display:none">0</span>
            <span>Panier</span>
        </button>
        <button class="nav-item" data-page="rewards" onclick="showPage('rewards')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
            <span>Fid√©lit√©</span>
        </button>
        <button class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span>Profil</span>
        </button>
    </nav>

    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
    <div id="productSheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">D√©tails</h2>
            <button class="sheet-close" onclick="closeModal()">‚úï</button>
        </div>
        <div id="productSheetContent" class="sheet-content"></div>
    </div>
    <div id="qrSheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Votre commande</h2>
            <button class="sheet-close" onclick="closeModal()">‚úï</button>
        </div>
        <div id="qrSheetContent" class="sheet-content"></div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
// ‚ö†Ô∏è IMPORTANT: Remplace cette URL par l'URL de ton API Vercel apr√®s d√©ploiement
const API_URL = 'https://ton-api-vercel.vercel.app/api';

let state={user:null,cart:[],categories:[],products:[],rewards:[],userRewards:[],orders:[],currentCategory:null,selectedRewardsForCart:[],selectedOrderType:'click-collect',selectedPickupTime:null};

function loadState(){
    const c=localStorage.getItem('cb_cart'),u=localStorage.getItem('cb_user');
    if(c)state.cart=JSON.parse(c);
    if(u)state.user=JSON.parse(u);
    updateCartBadge();updateUserBadge();
}
function saveCart(){localStorage.setItem('cb_cart',JSON.stringify(state.cart));updateCartBadge();}
function saveUser(){state.user?localStorage.setItem('cb_user',JSON.stringify(state.user)):localStorage.removeItem('cb_user');updateUserBadge();}
function updateCartBadge(){const b=document.getElementById('cartBadge'),t=state.cart.reduce((s,i)=>s+i.quantity,0);b.textContent=t;b.style.display=t>0?'flex':'none';}
function updateUserBadge(){const b=document.getElementById('userPointsBadge');b.className=state.user?'points-badge':'points-badge guest';b.innerHTML=state.user?`‚≠ê ${state.user.points} pts`:'Se connecter';}

async function apiCall(e,o={}){try{const r=await fetch(API_URL+e,{headers:{'Content-Type':'application/json'},...o});return await r.json();}catch(err){console.error(err);showToast('Erreur connexion','error');return null;}}
async function loadCategories(){const c=await apiCall('/categories');if(c){state.categories=c;renderCategories();}}
async function loadProducts(cid=null){const p=await apiCall(cid?`/products?categoryId=${cid}`:'/products');if(p)state.products=p;}
async function loadRewards(){const r=await apiCall('/rewards');if(r)state.rewards=r;}
async function loadUserRewards(){if(!state.user)return;const r=await apiCall(`/users/${state.user.id}/rewards`);if(r)state.userRewards=r;}
async function loadUserOrders(){if(!state.user)return;const o=await apiCall(`/users/${state.user.id}/orders`);if(o)state.orders=o;}
async function refreshUser(){if(!state.user)return;const u=await apiCall(`/users/${state.user.id}`);if(u){state.user=u;saveUser();}}

function renderCategories(){
    const c=document.getElementById('categoriesContainer'),m=document.getElementById('menuCategories');
    const all=`<div class="category-card ${!state.currentCategory?'active':''}" onclick="selectCategory(null)"><span>üìã</span><span>Tout</span></div>`;
    const h=state.categories.map(cat=>`<div class="category-card ${state.currentCategory===cat.id?'active':''}" onclick="selectCategory(${cat.id})"><span>${cat.icon}</span><span>${cat.name}</span></div>`).join('');
    c.innerHTML=h;m.innerHTML=all+h;
}
async function selectCategory(cid){state.currentCategory=cid;renderCategories();await loadProducts(cid);renderMenuProducts();showPage('menu');}
function getEmoji(cid){const c=state.categories.find(x=>x.id===cid);return c?c.icon:'üçî';}
function renderProductCard(p){return `<div class="product-card ${!p.available?'product-unavailable':''}" onclick="openProductDetail(${p.id})"><div class="product-image">${getEmoji(p.categoryId)}</div><div class="product-info"><div class="product-name">${p.name}</div><div class="product-price">${p.price.toFixed(2)}‚Ç¨</div></div></div>`;}
function renderPopularProducts(){document.getElementById('popularProducts').innerHTML=state.products.filter(p=>p.available).slice(0,6).map(p=>renderProductCard(p)).join('');}
function renderMenuProducts(){const f=state.currentCategory?state.products.filter(p=>p.categoryId===state.currentCategory):state.products;document.getElementById('menuProducts').innerHTML=f.map(p=>renderProductCard(p)).join('');}

function openProductDetail(pid){
    const p=state.products.find(x=>x.id===pid);if(!p||!p.available)return;
    document.getElementById('productSheetContent').innerHTML=`
        <div class="product-detail-image">${getEmoji(p.categoryId)}</div>
        <h2 class="product-detail-name">${p.name}</h2>
        <p class="product-detail-desc">${p.description}</p>
        <div class="quantity-selector">
            <button class="qty-btn" onclick="updateQty(-1)">‚àí</button>
            <span id="qtyValue" class="qty-value">1</span>
            <button class="qty-btn" onclick="updateQty(1)">+</button>
        </div>
        <button class="add-to-cart-btn" onclick="addToCart(${p.id})"><span>AJOUTER</span><span id="addToCartPrice">${p.price.toFixed(2)}‚Ç¨</span></button>`;
    document.getElementById('productSheet').dataset.productId=pid;
    document.getElementById('productSheet').dataset.price=p.price;
    openModal('productSheet');
}
function updateQty(d){const q=document.getElementById('qtyValue'),pr=document.getElementById('addToCartPrice'),s=document.getElementById('productSheet'),price=parseFloat(s.dataset.price);let qty=parseInt(q.textContent)+d;if(qty<1)qty=1;if(qty>10)qty=10;q.textContent=qty;pr.textContent=(price*qty).toFixed(2)+'‚Ç¨';}
function addToCart(pid){
    const p=state.products.find(x=>x.id===pid),qty=parseInt(document.getElementById('qtyValue').textContent);
    const ex=state.cart.find(i=>i.productId===pid);
    if(ex)ex.quantity+=qty;else state.cart.push({productId:p.id,name:p.name,price:p.price,categoryId:p.categoryId,quantity:qty});
    saveCart();closeModal();showToast(`${qty}x ${p.name} ajout√©`,'success');
}
function renderCart(){
    const c=document.getElementById('cartContent');
    if(!state.cart.length){c.innerHTML=`<div class="cart-empty"><div class="cart-empty-icon">üõí</div><h2>Panier vide</h2><p>Ajoutez des produits</p></div>`;return;}
    const items=state.cart.map((i,idx)=>`<div class="cart-item"><div class="cart-item-image">${getEmoji(i.categoryId)}</div><div class="cart-item-info"><div class="cart-item-name">${i.name}</div><div class="cart-item-price">${i.price.toFixed(2)}‚Ç¨</div><div class="cart-item-qty"><button class="cart-qty-btn" onclick="updateCartQty(${idx},-1)">‚àí</button><span>${i.quantity}</span><button class="cart-qty-btn" onclick="updateCartQty(${idx},1)">+</button></div></div><div class="cart-item-actions"><button class="cart-remove-btn" onclick="removeFromCart(${idx})">üóë</button><span>${(i.price*i.quantity).toFixed(2)}‚Ç¨</span></div></div>`).join('');
    const sub=state.cart.reduce((s,i)=>s+(i.price*i.quantity),0),pts=Math.floor(sub*4);
    c.innerHTML=`<div style="padding:0 16px">${items}<div class="cart-summary"><div class="cart-summary-row"><span>Sous-total</span><span>${sub.toFixed(2)}‚Ç¨</span></div><div class="cart-summary-row"><span>Points</span><span class="points">+${pts} pts</span></div><div class="cart-summary-row total"><span>Total</span><span>${sub.toFixed(2)}‚Ç¨</span></div></div><button class="checkout-btn" onclick="goToCheckout()">COMMANDER ‚Ä¢ ${sub.toFixed(2)}‚Ç¨</button></div>`;
}
function updateCartQty(i,d){state.cart[i].quantity+=d;if(state.cart[i].quantity<1)state.cart.splice(i,1);saveCart();renderCart();}
function removeFromCart(i){state.cart.splice(i,1);saveCart();renderCart();showToast('Retir√©','success');}
function goToCheckout(){if(!state.cart.length)return;renderCheckout();showPage('checkout');}

function renderCheckout(){
    const c=document.getElementById('checkoutContent'),sub=state.cart.reduce((s,i)=>s+(i.price*i.quantity),0),pts=Math.floor(sub*4);
    const avail=state.userRewards.filter(r=>r.status==='available');
    let rwHtml='';if(state.user&&avail.length){rwHtml=`<div class="cart-rewards"><h3>üéÅ Mes r√©compenses</h3>${avail.map(r=>`<div class="cart-reward-item"><input type="checkbox" class="cart-reward-checkbox" id="rw_${r.id}" onchange="toggleReward(${r.id})"><label for="rw_${r.id}">${r.rewardName}</label></div>`).join('')}</div>`;}
    const times=[];const now=new Date();now.setMinutes(Math.ceil(now.getMinutes()/15)*15+15);for(let i=0;i<8;i++){const t=new Date(now.getTime()+i*15*60000);times.push(t.toTimeString().slice(0,5));}
    state.selectedPickupTime=times[0];state.selectedRewardsForCart=[];
    c.innerHTML=`<div style="padding:0 16px"><h3 style="margin-bottom:16px">Type de commande</h3><div class="order-type-selector"><button class="order-type-btn selected" onclick="selectOrderType(this,'click-collect')"><div class="order-type-icon">üèÉ</div><div>Click & Collect</div></button><button class="order-type-btn" onclick="selectOrderType(this,'prepare')"><div class="order-type-icon">üì±</div><div>Pr√©parer</div></button></div><div id="pickupContainer"><h3 style="margin-bottom:16px">Heure retrait</h3><div class="pickup-time-selector">${times.map((t,i)=>`<button class="pickup-time-btn ${i===0?'selected':''}" onclick="selectPickupTime(this,'${t}')">${t}</button>`).join('')}</div></div>${rwHtml}${!state.user?`<div style="background:var(--dark-light);padding:16px;border-radius:var(--radius);margin-bottom:20px"><p style="font-size:14px;margin-bottom:12px"><strong>Connectez-vous</strong> pour gagner ${pts} points!</p><button class="auth-btn" style="padding:12px" onclick="showPage('login')">SE CONNECTER</button></div>`:''}<div class="cart-summary"><div class="cart-summary-row"><span>Total</span><span>${sub.toFixed(2)}‚Ç¨</span></div>${state.user?`<div class="cart-summary-row"><span>Points</span><span class="points">+${pts} pts</span></div>`:''}</div><button class="checkout-btn" onclick="placeOrder()">CONFIRMER</button></div>`;
}
function selectOrderType(btn,t){document.querySelectorAll('.order-type-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');state.selectedOrderType=t;document.getElementById('pickupContainer').style.display=t==='prepare'?'none':'block';}
function selectPickupTime(btn,t){document.querySelectorAll('.pickup-time-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');state.selectedPickupTime=t;}
function toggleReward(rid){const i=state.selectedRewardsForCart.indexOf(rid);if(i>-1)state.selectedRewardsForCart.splice(i,1);else state.selectedRewardsForCart.push(rid);}

async function placeOrder(){
    const sub=state.cart.reduce((s,i)=>s+(i.price*i.quantity),0);
    const data={userId:state.user?state.user.id:null,items:state.cart.map(i=>({productId:i.productId,quantity:i.quantity,price:i.price})),total:sub,type:state.selectedOrderType,pickupTime:state.selectedOrderType==='click-collect'?state.selectedPickupTime:null,usedRewards:state.selectedRewardsForCart};
    const r=await apiCall('/orders',{method:'POST',body:JSON.stringify(data)});
    if(r&&r.orderCode){state.cart=[];saveCart();renderConfirmation(r);showPage('confirmation');if(state.user){await refreshUser();await loadUserRewards();}}else showToast('Erreur commande','error');
}
function renderConfirmation(o){
    document.getElementById('confirmationContent').innerHTML=`<div style="font-size:64px;margin-bottom:20px">‚úÖ</div><h2 style="font-family:'Bebas Neue',sans-serif;font-size:28px;margin-bottom:8px">COMMANDE CONFIRM√âE!</h2><p style="color:var(--gray);margin-bottom:24px">Pr√©sentez ce QR code au comptoir</p><div class="qr-container"><div id="confirmQR"></div><div class="qr-code-text">${o.orderCode}</div></div><div style="background:var(--dark-light);padding:16px;border-radius:var(--radius);text-align:left;margin-top:20px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Total</span><strong>${o.total.toFixed(2)}‚Ç¨</strong></div>${state.user?`<div style="display:flex;justify-content:space-between;color:var(--secondary)"><span>Points gagn√©s</span><strong>+${o.pointsEarned} pts</strong></div>`:''}</div><p class="qr-instructions">${o.type==='click-collect'?`Retrait √† <strong>${o.pickupTime}</strong>`:'Montrez ce code quand vous √™tes pr√™t'}</p><button class="checkout-btn" style="margin-top:24px" onclick="showPage('home')">RETOUR</button>`;
    setTimeout(()=>{const qr=document.getElementById('confirmQR');qr.innerHTML='';new QRCode(qr,{text:o.orderCode,width:180,height:180,colorDark:'#1A1A1A',colorLight:'#FFF'});},100);
}

function getRewardEmoji(t){return{drink:'ü•§',side:'üçü',dessert:'üç¶',burger:'üçî',menu:'üéÅ'}[t]||'üéÅ';}
function renderRewards(){
    const c=document.getElementById('rewardsContent');
    if(!state.user){c.innerHTML=`<div class="rewards-header" style="background:var(--dark-light)"><div class="rewards-points">üéÅ</div><div class="rewards-points-label">Programme Fid√©lit√©</div><div class="rewards-info">Connectez-vous pour gagner</div></div><div style="padding:20px 16px"><button class="auth-btn" onclick="showPage('login')">SE CONNECTER</button><p class="auth-link">Pas de compte ? <a href="#" onclick="showPage('register')">S'inscrire</a></p></div><h2 class="section-title">R√©compenses</h2><div style="padding:0 16px">${state.rewards.map(r=>`<div class="reward-card"><div class="reward-icon">${getRewardEmoji(r.type)}</div><div class="reward-info"><div class="reward-name">${r.name}</div><div class="reward-desc">${r.description}</div></div><div style="background:var(--gradient-gold);padding:8px 14px;border-radius:20px;font-weight:700;font-size:13px;color:var(--dark)">${r.pointsCost} pts</div></div>`).join('')}</div>`;return;}
    const avail=state.userRewards.filter(r=>r.status==='available'),used=state.userRewards.filter(r=>r.status==='used');
    c.innerHTML=`<div class="rewards-header"><div class="rewards-points">${state.user.points}</div><div class="rewards-points-label">Points</div><div class="rewards-info">1‚Ç¨ = 4 points</div></div>${avail.length?`<h2 class="section-title">Mes r√©compenses</h2><div style="padding:0 16px">${avail.map(r=>`<div class="my-reward-card"><div class="my-reward-header"><span style="font-weight:600">${r.rewardName}</span><span class="my-reward-status available">Disponible</span></div><div class="my-reward-code">${r.code}</div></div>`).join('')}</div>`:''}<h2 class="section-title">√âchanger</h2><div style="padding:0 16px">${state.rewards.map(r=>`<div class="reward-card"><div class="reward-icon">${getRewardEmoji(r.type)}</div><div class="reward-info"><div class="reward-name">${r.name}</div><div class="reward-desc">${r.description}</div></div><button class="reward-claim-btn" ${state.user.points<r.pointsCost?'disabled':''} onclick="claimReward(${r.id})">${r.pointsCost} pts</button></div>`).join('')}</div>`;
}
async function claimReward(rid){
    const r=await apiCall('/rewards/redeem',{method:'POST',body:JSON.stringify({userId:state.user.id,rewardId:rid})});
    if(r&&r.success){state.user.points=r.remainingPoints;saveUser();await loadUserRewards();renderRewards();showToast('R√©compense r√©clam√©e!','success');}else showToast(r?.message||'Erreur','error');
}

function renderProfile(){
    const c=document.getElementById('profileContent');
    if(!state.user){c.innerHTML=`<div class="auth-page"><img src="images/logo.png" class="auth-logo"><h1 class="auth-title">MON COMPTE</h1><p class="auth-subtitle">Connectez-vous</p><button class="auth-btn" onclick="showPage('login')">SE CONNECTER</button><p class="auth-link">Pas de compte ? <a href="#" onclick="showPage('register')">S'inscrire</a></p></div>`;return;}
    c.innerHTML=`<div class="profile-header"><div class="profile-avatar">üë§</div><div class="profile-name">${state.user.name}</div><div class="profile-email">${state.user.email}</div></div><div class="profile-menu"><div class="profile-menu-item" onclick="showPage('orders')"><div class="profile-menu-icon">üì¶</div><div class="profile-menu-text"><h3>Mes commandes</h3><p>Historique</p></div><span class="profile-menu-arrow">‚Ä∫</span></div><div class="profile-menu-item" onclick="showPage('rewards')"><div class="profile-menu-icon">‚≠ê</div><div class="profile-menu-text"><h3>Mes points</h3><p>${state.user.points} points</p></div><span class="profile-menu-arrow">‚Ä∫</span></div></div><button class="logout-btn" onclick="logout()">D√âCONNEXION</button>`;
}
function renderOrders(){
    const c=document.getElementById('ordersContent');
    if(!state.user){c.innerHTML=`<div class="cart-empty"><div class="cart-empty-icon">üì¶</div><h2>Connectez-vous</h2><button class="auth-btn" style="margin-top:20px" onclick="showPage('login')">SE CONNECTER</button></div>`;return;}
    if(!state.orders.length){c.innerHTML=`<div class="cart-empty"><div class="cart-empty-icon">üì¶</div><h2>Aucune commande</h2></div>`;return;}
    const labels={pending:'En attente',preparing:'Pr√©paration',ready:'Pr√™te',completed:'Termin√©e',cancelled:'Annul√©e'};
    c.innerHTML=`<div style="padding:0 16px">${state.orders.map(o=>{const items=o.items.map(i=>{const p=state.products.find(x=>x.id===i.productId);return `${i.quantity}x ${p?p.name:'?'}`;}).join(', ');return `<div class="order-card"><div class="order-header"><span class="order-code">${o.orderCode}</span><span class="order-status ${o.status}">${labels[o.status]}</span></div><div class="order-items">${items}</div><div class="order-footer"><div><div class="order-total">${o.total.toFixed(2)}‚Ç¨</div><div class="order-date">${new Date(o.createdAt).toLocaleDateString('fr-FR')}</div></div>${['pending','preparing','ready'].includes(o.status)?`<button class="order-qr-btn" onclick="showOrderQR('${o.orderCode}')">QR</button>`:''}</div></div>`;}).join('')}</div>`;
}
function showOrderQR(code){
    document.getElementById('qrSheetContent').innerHTML=`<div style="text-align:center"><div class="qr-container"><div id="orderQR"></div><div class="qr-code-text">${code}</div></div><p class="qr-instructions">Pr√©sentez ce code</p></div>`;
    openModal('qrSheet');
    setTimeout(()=>{const qr=document.getElementById('orderQR');qr.innerHTML='';new QRCode(qr,{text:code,width:180,height:180,colorDark:'#1A1A1A',colorLight:'#FFF'});},100);
}

document.getElementById('loginForm').addEventListener('submit',async e=>{e.preventDefault();const r=await apiCall('/auth/login',{method:'POST',body:JSON.stringify({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPassword').value})});if(r&&r.success){state.user=r.user;saveUser();await loadUserRewards();await loadUserOrders();showToast('Connect√©!','success');showPage('home');}else showToast(r?.message||'Erreur','error');});
document.getElementById('registerForm').addEventListener('submit',async e=>{e.preventDefault();const r=await apiCall('/auth/register',{method:'POST',body:JSON.stringify({name:document.getElementById('registerName').value,email:document.getElementById('registerEmail').value,phone:document.getElementById('registerPhone').value,password:document.getElementById('registerPassword').value})});if(r&&r.success){state.user=r.user;saveUser();showToast('Compte cr√©√©!','success');showPage('home');}else showToast(r?.message||'Erreur','error');});
function logout(){state.user=null;state.userRewards=[];state.orders=[];saveUser();showToast('D√©connect√©','success');showPage('home');}

function showPage(pid){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));const pg=document.getElementById(pid+'Page');if(pg)pg.classList.add('active');document.querySelectorAll('.nav-item').forEach(i=>i.classList.toggle('active',i.dataset.page===pid));switch(pid){case'cart':renderCart();break;case'rewards':renderRewards();break;case'profile':renderProfile();break;case'orders':renderOrders();break;case'menu':renderMenuProducts();break;}window.scrollTo(0,0);}
function openModal(sid){document.getElementById('modalOverlay').classList.add('active');document.getElementById(sid).classList.add('active');document.body.style.overflow='hidden';}
function closeModal(){document.getElementById('modalOverlay').classList.remove('active');document.querySelectorAll('.bottom-sheet').forEach(s=>s.classList.remove('active'));document.body.style.overflow='';}
function showToast(msg,type='success'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3000);}

async function init(){loadState();await loadCategories();await loadProducts();await loadRewards();if(state.user){await refreshUser();await loadUserRewards();await loadUserOrders();}renderPopularProducts();}
init();
    </script>
</body>
</html>
