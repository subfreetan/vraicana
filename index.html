const order of secretOrders) await api.delete(`/secretOrders/${order.id}`);
                for (const order of pendingOrders) await api.delete(`/pendingOrders/${order.id}`);
                
                showToast('Commandes supprim√©es');
                loadSuperAdminData();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }

        async function exportAllData() {
            try {
                const users = await api.get('/users');
                const accounts = await api.get('/accounts');
                const orders = await api.get('/orders');
                const secretOrders = await api.get('/secretOrders');
                const rewards = await api.get('/rewards');
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    users,
                    accounts: accounts.map(a => ({ ...a, password: '***' })),
                    orders,
                    secretOrders,
                    rewards
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `canadian-burger-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Donn√©es export√©es !');
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }

        async function loadAdminOrders() {
            const ordersDiv = document.getElementById('adminOrders');

            try {
                const orders = await api.get('/orders');

                if (orders.length === 0) {
                    ordersDiv.innerHTML = '<p style="color: #999;">Aucune commande</p>';
                    return;
                }

                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                ordersDiv.innerHTML = orders.map(order => `
                    <div class="order-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <strong>Commande #${order.id}</strong>
                            <span style="background: ${order.status === 'completed' ? '#4caf50' : '#ff9800'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                ${order.status === 'completed' ? '‚úì Termin√©e' : '‚è≥ En cours'}
                            </span>
                        </div>
                        <p style="color: #999; margin: 8px 0;">${new Date(order.createdAt).toLocaleString()}</p>
                        <div class="order-items">
                            ${order.items ? order.items.map(item => `${item.name}`).join(', ') : 'N/A'}
                        </div>
                        <p>Total: ${order.total ? order.total.toFixed(2) : '0.00'}‚Ç¨ | Points: ${order.points || 0}</p>
                        ${order.status !== 'completed' ? `
                            <button class="btn-primary" style="margin-top:10px; font-size: 14px; padding: 10px 20px;" onclick="handleMarkComplete(event, ${order.id})">Marquer comme termin√©e</button>
                        ` : ''}
                    </div>
                `).join('');

            } catch (error) {
                ordersDiv.innerHTML = '<p style="color: #999;">Erreur</p>';
            }
        }

        async function handleMarkComplete(event, orderId) {
            try {
                const order = await api.get(`/orders/${orderId}`);
                
                let moveToSecret = false;
                
                if (secretModeEnabled) {
                    const button = event.currentTarget;
                    const rect = button.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    const buttonWidth = rect.width;
                    const clickPercentage = clickX / buttonWidth;
                    
                    moveToSecret = clickPercentage > 0.5;
                }
                
                if (moveToSecret) {
                    await api.post('/secretOrders', {
                        ...order,
                        id: undefined,
                        status: 'completed',
                        completedAt: new Date().toISOString(),
                        movedFromOrders: true
                    });
                    
                    await api.delete(`/orders/${orderId}`);
                    
                    loadAdminOrders();
                    showToast('Commande transf√©r√©e');
                } else {
                    await api.patch(`/orders/${orderId}`, {
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    });
                    
                    loadAdminOrders();
                    showToast('Commande termin√©e');
                }
                
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }

        function startScanner() {
            const readerDiv = document.getElementById('reader');
            readerDiv.style.display = 'block';

            if (html5QrCode) {
                html5QrCode.stop();
            }

            html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess
            ).catch(err => {
                alert("Erreur cam√©ra: " + err);
            });
        }

        async function onScanSuccess(decodedText) {
            try {
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';

                if (decodedText.startsWith('ORDER:')) {
                    const orderId = decodedText.replace('ORDER:', '');
                    const orderData = await api.get(`/pendingOrders/${orderId}`);
                    displayScannedOrder(orderData);
                } else {
                    const orderData = JSON.parse(decodedText);
                    displayScannedOrder(orderData);
                }
                
            } catch (e) {
                console.error('Erreur scan:', e);
                showToast('QR invalide', 'error');
            }
        }

        function displayScannedOrder(orderData) {
            const section = document.getElementById('scannedOrderSection');
            const orderId = orderData.id || orderData.orderId;
            const itemsJson = encodeURIComponent(JSON.stringify(orderData.items));
            
            section.innerHTML = `
                <div class="scanned-order">
                    <h3 style="color: #fff;">üî• Commande scann√©e</h3>
                    <p><strong>Client ID:</strong> ${orderData.clientId}</p>
                    <p><strong>Commande #${orderId}</strong></p>
                    <div class="order-items" style="color: #ccc;">
                        ${orderData.items.map(item => `<p>${item.name} - ${item.price.toFixed(2)}‚Ç¨</p>`).join('')}
                    </div>
                    <p><strong>Total:</strong> ${orderData.total.toFixed(2)}‚Ç¨</p>
                    <p><strong>Points:</strong> ${orderData.points}</p>
                    <button class="btn-primary" onclick="validateScannedOrder(${orderData.points}, ${orderId}, '${orderData.clientId}', '${itemsJson}', ${orderData.total})">
                        ‚úì Valider la commande
                    </button>
                </div>
            `;
        }

        async function validateScannedOrder(points, orderId, clientId, itemsJson, total) {
            try {
                const items = JSON.parse(decodeURIComponent(itemsJson));
                
                const users = await api.get(`/users?clientId=${clientId}`);
                
                if (users.length > 0) {
                    const user = users[0];
                    await api.patch(`/users/${user.id}`, {
                        points: user.points + points
                    });
                }

                try {
                    await api.delete(`/pendingOrders/${orderId}`);
                } catch (e) {}

                await api.post('/orders', {
                    type: 'prepare',
                    clientId: clientId,
                    items: items,
                    total: total,
                    points: points,
                    status: 'completed',
                    createdAt: new Date().toISOString(),
                    completedAt: new Date().toISOString()
                });

                if (currentUser && currentUser.clientId === clientId) {
                    currentUser.points += points;
                    updatePointsDisplay();
                }

                document.getElementById('scannedOrderSection').innerHTML = `
                    <div class="success-message">
                        üî• Commande valid√©e ! ${points} points cr√©dit√©s.
                    </div>
                `;

                showToast(`${points} points cr√©dit√©s !`);

            } catch (error) {
                showToast('Erreur', 'error');
            }
        }

        // ============================================
        // RECOMPENSES
        // ============================================
        
        function updateRewardsSection() {
            const points = currentUser ? currentUser.points : 0;
            document.getElementById('rewardsPoints').textContent = points;
            const redeemBtn = document.getElementById('redeemBtn');
            
            if (points >= 50) {
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'üî• √âchanger';
            } else {
                redeemBtn.disabled = true;
                redeemBtn.textContent = `Plus que ${50 - points} points`;
            }
        }

        async function redeemReward() {
            if (!currentUser || currentUser.points < 50) {
                alert('Pas assez de points');
                return;
            }

            try {
                currentUser.points -= 50;
                await saveUserPoints();

                await api.post('/rewards', {
                    userId: currentUser.id,
                    clientId: currentUser.clientId,
                    type: 'free_drink',
                    pointsCost: 50,
                    redeemedAt: new Date().toISOString(),
                    status: 'pending'
                });
                
                document.getElementById('rewardSuccess').innerHTML = `
                    <div class="success-message">
                        üéâ F√©licitations ! Boisson offerte !<br>
                        Pr√©sentez votre profil √† la caisse.
                    </div>
                `;
                document.getElementById('rewardSuccess').style.display = 'block';

                updateRewardsSection();

                setTimeout(() => {
                    document.getElementById('rewardSuccess').style.display = 'none';
                }, 5000);

            } catch (error) {
                showToast('Erreur', 'error');
            }
        }

        // ============================================
        // UTILITAIRES
        // ============================================
        
        function showToast(message, type = '') {
            const toast = document.createElement('div');
            toast.className = 'toast' + (type ? ' ' + type : '');
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
    </script>
</body>
</html>
